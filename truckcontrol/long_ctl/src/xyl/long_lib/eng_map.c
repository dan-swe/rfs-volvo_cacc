/************************************************************************

    eng_map()

    input: we - [rpm]
    eng_tbl: ww - rad/s]
    This conversion is important.
    For each spd 19 points
    19 spd
    dat[361][4]
    
    Using new engine data based on N14_435 from May 15  02
    Using modified new engine data based on N14_435 on June 3  02
              Maximum torque is generally reduced  vs  previous one.
         
*************************************************************************/

#include <math.h>
#include <stdio.h>

float eng_map( float we, float in_value, int in_index, int out_index , int Index[3])
{
   static float  outa=0.0, outb=0.0, a=0.0, b=0.0, r=0.0, ww=0.0;
   static float ta=0.0,tb=0.0;         
   static int i=0, j=0, k=0;
   static int ind_I=0, ind_J=0, ind_K=0;
   const float dat[304][4]={600.000,   0.000,     101300.000,  10.000, 
600.000,  205.675,  111233.575,  15.000, 
600.000,  344.120,  116446.445,  20.000, 
600.000,  482.565,  121882.387,  25.000, 
600.000,  621.009,  127554.001,  30.000, 
600.000,  759.454,  133368.219,  35.000, 
600.000,  897.900,  139353.453,  40.000, 
600.000,  905.246,  145470.329,  45.000, 
600.000,  905.246,  148984.570,  50.000, 
600.000,  905.246,  149040.084,  55.000, 
600.000,  913.531,  149040.461,  60.000, 
600.000,  913.531,  149040.464,  65.000, 
600.000,  938.389,  149040.464,  70.000, 
600.000,  938.389,  149040.464,  75.000, 
600.000,  938.389,  149040.464,  80.000, 
600.000,  946.674,  149040.464,  85.000, 
600.000,  946.674,  149040.464,  90.000, 
600.000,  954.960,  149040.464,  95.000, 
600.000,  954.960,  149040.464,  100.00,  
700.000,   0.000,     101300.000,  10.000, 
700.000,  222.246,  111233.575,  15.000, 
700.000,  360.691,  116446.445,  20.000, 
700.000,  499.136,  121882.387,  25.000, 
700.000,  637.581,  127554.001,  30.000, 
700.000,  776.026,  133368.219,  35.000, 
700.000,  914.471,  139353.453,  40.000, 
700.000,  921.817,  145470.329,  45.000, 
700.000,  930.103,  148984.570,  50.000, 
700.000,  938.389,  149040.084,  55.000, 
700.000,  946.674,  149040.461,  60.000, 
700.000,  954.960,  149040.464,  65.000, 
700.000,  954.960,  149040.464,  70.000, 
700.000,  963.246,  149040.464,  75.000, 
700.000,  963.246,  149040.464,  80.000, 
700.000,  963.246,  149040.464,  85.000, 
700.000,  971.531,  149040.464,  90.000, 
700.000,  971.531,  149040.464,  95.000, 
700.000,  971.531,  149040.464,  100.00,   
800.000,   0.000,       101300.000,  10.000,
800.000,  219.403,    112249.639,  15.000,
800.000,  377.472,    118934.530,  20.000,
800.000,  536.993,    125930.774,  25.000,
800.000,  701.017,    133222.335,  30.000,
800.000,  845.787,    140700.519,  35.000,
800.000,  976.992,    147702.239,  40.000,
800.000,  1101.987,  155218.821,  45.000,
800.000,  1208.580,  162303.174,  50.000,
800.000,  1208.580,  162782.776,  55.000,
800.000,  1208.580,  162786.036,  60.000,
800.000,  1208.580,  162786.059,  65.000,
800.000,  1208.580,  162786.059,  70.000,
800.000,  1208.580,  162786.059,  75.000,
800.000,  1208.580,  162786.059,  80.000,
800.000,  1208.580,  162786.059,  85.000,
800.000,  1208.580,  162786.059,  90.000,
800.000,  1208.580,  162786.059,  95.000,
800.000,  1208.580,  162786.059,  100.000,
900.000,  -3.128,       107361.551,  10.000,
900.000,  179.674,    114386.998,  15.000,
900.000,  347.458,    121966.415,  20.000,
900.000,  496.780,    129949.470,  25.000,
900.000,  642.374,    138257.531,  30.000,
900.000,  762.899,    146216.354,  35.000,
900.000,  876.740,    154449.831,  40.000,
900.000,  1009.194,  163233.386,  45.000,
900.000,  1134.424,  172316.275,  50.000,
900.000,  1251.989,  181546.882,  55.000,
900.000,  1353.886,  187020.154,  60.000,
900.000,  1353.886,  187020.154,  65.000,
900.000,  1353.886,  187020.154,  70.000,
900.000,  1353.886,  187020.154,  75.000,
900.000,  1353.886,  187020.154,  80.000,
900.000,  1353.886,  187020.152,  85.000,
900.000,  1353.886,  187019.877,  90.000,
900.000,  1353.886,  186979.348,  95.000,
900.000,  1351.000,  181018.152,  100.000,
1000.000,  -70.731,   104744.924,  10.000,
1000.000,  115.859,  110242.490,  15.000,
1000.000,  295.832,  118284.531,  20.000,
1000.000,  448.535,  126886.011,  25.000,
1000.000,  588.432,  135930.664,  30.000,
1000.000,  724.817,  144827.579,  35.000,
1000.000,  859.995,  153798.535,  40.000,
1000.000,  991.080,  163458.124,  45.000,
1000.000,  1125.600,  173488.013,  50.000,
1000.000,  1257.499,  183690.732,  55.000,
1000.000,  1385.729,  193895.535,  60.000,
1000.000,  1536.334,  204318.736,  65.000,
1000.000,  1638.902,  215105.691,  70.000,
1000.000,  1669.765,  223509.153,  75.000,
1000.000,  1669.765,  223817.647,  80.000,
1000.000,  1669.765,  223819.759,  85.000,
1000.000,  1669.765,  223819.759,  90.000,
1000.000,  1669.765,  223819.759,  95.000,
1000.000,  1669.765,  223819.759,  100.000,
1100.000,  -138.802,   104029.811,  10.000,
1100.000,  51.933,      111823.462,  15.000,
1100.000,  236.592,    120756.794,  20.000,
1100.000,  394.511,    129325.283,  25.000,
1100.000,  538.267,    140269.620,  30.000,
1100.000,  680.125,    149734.194,  35.000,
1100.000,  819.716,    160060.520,  40.000,
1100.000,  957.804,    170881.587,  45.000,
1100.000,  1093.493,  182005.895,  50.000,
1100.000,  1227.051,  193133.674,  55.000,
1100.000,  1362.448,  204483.042,  60.000,
1100.000,  1501.081,  216230.649,  65.000,
1100.000,  1646.609,  226297.423,  70.000,
1100.000,  1805.656,  239695.569,  75.000,
1100.000,  1904.455,  251435.744,  80.000,
1100.000,  1904.455,  261067.596,  85.000,
1100.000,  1904.455,  261236.354,  90.000,
1100.000,  1904.455,  261199.908,  95.000,
1100.000,  1902.535,  255839.188,  100.000,
1200.000,  -186.247,   101355.022,  10.000,
1200.000,  -16.805,     106364.884,  15.000,
1200.000,  173.099,    115393.385,  20.000,
1200.000,  341.993,    125388.353,  25.000,
1200.000,  489.609,    136008.726,  30.000,
1200.000,  631.866,    146423.050,  35.000,
1200.000,  772.093,    157261.353,  40.000,
1200.000,  913.683,    168847.127,  45.000,
1200.000,  1052.701,  180845.482,  50.000,
1200.000,  1189.745,  192868.963,  55.000,
1200.000,  1328.125,  205138.736,  60.000,
1200.000,  1466.879,  217876.624,  65.000,
1200.000,  1611.080,  230425.082,  70.000,
1200.000,  1748.326,  243263.069,  75.000,
1200.000,  1860.723,  255648.989,  80.000,
1200.000,  1860.723,  269715.762,  85.000,
1200.000,  1860.723,  281665.522,  90.000,
1200.000,  1860.723,  286091.108,  95.000,
1200.000,  1860.723,  286126.560,  100.000,
1300.000,  -197.978,   101446.270,  10.000,
1300.000,  -94.351,     107341.395,  15.000,
1300.000,  99.309,      117239.467,  20.000,
1300.000,  282.003,    127018.592,  25.000,
1300.000,  432.677,    139646.953,  30.000,
1300.000,  578.532,    150706.005,  35.000,
1300.000,  724.706,    162830.743,  40.000,
1300.000,  869.173,    175537.174,  45.000,
1300.000,  1011.289,  188445.000,  50.000,
1300.000,  1150.285,  201476.260,  55.000,
1300.000,  1286.324,  215044.863,  60.000,
1300.000,  1422.840,  228547.636,  65.000,
1300.000,  1558.309,  242304.689,  70.000,
1300.000,  1692.879,  255662.159,  75.000,
1300.000,  1824.320,  269354.330,  80.000,
1300.000,  1837.895,  283595.233,  85.000,
1300.000,  1837.895,  297656.546,  90.000,
1300.000,  1837.895,  302821.377,  95.000,
1300.000,  1837.663,  299527.928,  100.000,
1400.000,  -209.905,   101291.062,  10.000,
1400.000,  -172.364,   101896.483,  15.000,
1400.000,  25.911,      110492.732,  20.000,
1400.000,  213.923,    121477.377,  25.000,
1400.000,  372.262,    133434.100,  30.000,
1400.000,  523.772,    145485.196,  35.000,
1400.000,  669.093,    157858.974,  40.000,
1400.000,  810.709,    171205.308,  45.000,
1400.000,  953.154,    184958.345,  50.000,
1400.000,  1094.924,  198780.914,  55.000,
1400.000,  1235.442,  213170.320,  60.000,
1400.000,  1372.925,  227589.746,  65.000,
1400.000,  1508.660,  242256.144,  70.000,
1400.000,  1639.695,  256442.467,  75.000,
1400.000,  1768.503,  271197.322,  80.000,
1400.000,  1851.769,  287902.824,  85.000,
1400.000,  1862.396,  301587.321,  90.000,
1400.000,  1862.396,  317169.388,  95.000,
1400.000,  1862.396,  321330.166,  100.000,
1500.000,  -221.975,   101295.903,  10.000,
1500.000,  -221.975,   102158.212,  15.000,
1500.000,  -55.100,     111719.587,  20.000,
1500.000,  140.419,    123570.523,  25.000,
1500.000,  313.437,    136418.351,  30.000,
1500.000,  462.536,    149071.493,  35.000,
1500.000,  611.121,    162664.720,  40.000,
1500.000,  758.724,    177073.182,  45.000,
1500.000,  901.120,    191694.208,  50.000,
1500.000,  1041.635,  206621.901,  55.000,
1500.000,  1180.801,  222062.170,  60.000,
1500.000,  1314.783,  237461.935,  65.000,
1500.000,  1447.489,  252849.998,  70.000,
1500.000,  1576.816,  268124.231,  75.000,
1500.000,  1701.678,  284252.642,  80.000,
1500.000,  1804.767,  300393.787,  85.000,
1500.000,  1850.998,  316903.596,  90.000,
1500.000,  1850.998,  333111.263,  95.000,
1500.000,  1851.131,  334116.122,  100.000,
1600.000,  -234.896,   101290.040,  10.000,
1600.000,  -234.974,   101290.000,  15.000,
1600.000,  -136.669,   104365.252,  20.000,
1600.000,  56.803,      115441.282,  25.000,
1600.000,  236.522,    128379.554,  30.000,
1600.000,  393.175,    142059.354,  35.000,
1600.000,  543.068,    155641.436,  40.000,
1600.000,  688.754,    170507.565,  45.000,
1600.000,  831.294,    185924.048,  50.000,
1600.000,  971.857,    201495.920,  55.000,
1600.000,  1108.885,  217745.040,  60.000,
1600.000,  1243.247,  233939.426,  65.000,
1600.000,  1374.266,  250307.763,  70.000,
1600.000,  1500.311,  266311.757,  75.000,
1600.000,  1624.710,  283323.443,  80.000,
1600.000,  1729.841,  300357.068,  85.000,
1600.000,  1799.194,  317816.425,  90.000,
1600.000,  1799.194,  335391.175,  95.000,
1600.000,  1799.194,  348601.605,  100.000,
1700.000,  -247.972,   101290.195,  10.000,
1700.000,  -247.972,   101318.722,  15.000,
1700.000,  -219.448,   104846.781,  20.000,
1700.000,  -27.522,     116835.972,  25.000,
1700.000,  162.477,    130618.650,  30.000,
1700.000,  327.085,    144933.438,  35.000,
1700.000,  476.346,    159553.947,  40.000,
1700.000,  623.402,    175449.350,  45.000,
1700.000,  767.146,    191695.900,  50.000,
1700.000,  906.559,    208321.763,  55.000,
1700.000,  1042.080,  225433.019,  60.000,
1700.000,  1173.861,  242658.716,  65.000,
1700.000,  1301.705,  259383.539,  70.000,
1700.000,  1425.662,  277082.409,  75.000,
1700.000,  1547.935,  295005.941,  80.000,
1700.000,  1641.319,  313207.574,  85.000,
1700.000,  1744.380,  331687.864,  90.000,
1700.000,  1753.046,  349274.588,  95.000,
1700.000,  1753.096,  350658.476,  100.000,
1800.000,  -262.051,   101290.001,  10.000,
1800.000,  -262.138,   101290.000,  15.000,
1800.000,  -262.138,   101290.000,  20.000,
1800.000,  -110.093,   107701.610,  25.000,
1800.000,  83.624,      120992.143,  30.000,
1800.000,  261.848,    135849.092,  35.000,
1800.000,  411.698,    150638.611,  40.000,
1800.000,  558.165,    166705.501,  45.000,
1800.000,  699.260,    183662.012,  50.000,
1800.000,  838.799,    200811.877,  55.000,
1800.000,  974.309,    218713.836,  60.000,
1800.000,  1103.462,  236633.732,  65.000,
1800.000,  1228.257,  254442.515,  70.000,
1800.000,  1350.154,  272599.695,  75.000,
1800.000,  1469.070,  291388.404,  80.000,
1800.000,  1572.930,  310389.926,  85.000,
1800.000,  1644.552,  329763.384,  90.000,
1800.000,  1644.552,  347896.314,  95.000,
1800.000,  1644.552,  349282.876,  100.000,
1900.000,  -276.969,   101290.005,  10.000,
1900.000,  -276.969,   101290.795,  15.000,
1900.000,  -276.969,   101406.877,  20.000,
1900.000,  -197.358,   108325.828,  25.000,
1900.000,  -3.498,       122444.860,  30.000,
1900.000,  190.362,    138057.284,  35.000,
1900.000,  343.488,    153600.768,  40.000,
1900.000,  489.794,    170672.724,  45.000,
1900.000,  630.902,    188473.300,  50.000,
1900.000,  768.322,    206594.956,  55.000,
1900.000,  901.385,    225340.574,  60.000,
1900.000,  1029.937,  244221.351,  65.000,
1900.000,  1155.724,  262550.948,  70.000,
1900.000,  1274.635,  282158.249,  75.000,
1900.000,  1388.834,  301830.974,  80.000,
1900.000,  1487.684,  321999.015,  85.000,
1900.000,  1540.131,  341963.501,  90.000,
1900.000,  1540.131,  347589.673,  95.000,
1900.000,  1540.797,  348039.786,  100.000,
2000.000,  -291.878,   101290.000,  10.000,
2000.000,  -291.968,   101290.000,  15.000,
2000.000,  -291.968,   101290.000,  20.000,
2000.000,  -290.249,   101310.182,  25.000,
2000.000,  -92.321,     111765.992,  30.000,
2000.000,  102.152,    126979.823,  35.000,
2000.000,  271.461,    143315.037,  40.000,
2000.000,  417.649,    160000.619,  45.000,
2000.000,  559.539,    178218.536,  50.000,
2000.000,  696.993,    196796.462,  55.000,
2000.000,  829.789,    216190.286,  60.000,
2000.000,  957.005,    235697.554,  65.000,
2000.000,  1081.107,  255081.640,  70.000,
2000.000,  1199.868,  274989.629,  75.000,
2000.000,  1309.450,  295459.692,  80.000,
2000.000,  1386.836,  316315.681,  85.000,
2000.000,  1421.093,  337476.572,  90.000,
2000.000,  1421.093,  349374.116,  95.000,
2000.000,  1421.093,  349548.526,  100.000,
2100.000,  -306.966,   101290.000,  10.000,
2100.000,  -306.966,   101290.019,  15.000,
2100.000,  -306.966,   101292.759,  20.000,
2100.000,  -306.966,   101695.745,  25.000,
2100.000,  -181.624,   112387.430,  30.000,
2100.000,  13.184,      128338.946,  35.000,
2100.000,  200.236,    145312.140,  40.000,
2100.000,  350.705,    162893.981,  45.000,
2100.000,  494.022,    181973.072,  50.000,
2100.000,  631.800,    201385.342,  55.000,
2100.000,  766.140,    221669.999,  60.000,
2100.000,  894.472,    242030.840,  65.000,
2100.000,  1016.270,  261954.645,  70.000,
2100.000,  1133.752,  283157.785,  75.000,
2100.000,  1234.309,  304493.836,  80.000,
2100.000,  1269.230,  326393.171,  85.000,
2100.000,  1269.230,  346878.472,  90.000,
2100.000,  1269.230,  348369.461,  95.000,
2100.000,  1270.228,  354058.725,  100.000};

   ww = we;   // * 2.0 * PI / 60.0;    /* rpm to rad/s */

   if( ww <= dat[0][0] )
   {
      ind_I = 0;
      ww = dat[0][0];
   }
   else if( ww >= dat[303][0] )
   {
      ind_I = 14;    // Err
      ww = dat[303][0];
   }
   else
   {
      for( i = 0; i < 15; i++ )
         if( (ww >= dat[i*19][0] && ww < dat[(i+1) * 19][0] ) ||
        (ww <= dat[i*19][0] && ww > dat[(i+1) * 19][0] ) ) 
           {ind_I=i; break;}
   }                       


   if( in_value < dat[ind_I*19][in_index] )
   {
    ind_J = 0;
    in_value = dat[ind_I*19][in_index];   
   }
   else if( in_value > dat[ind_I*19 + 18][in_index] )
   {
    ind_J = 18;
       in_value = dat[ind_I*19 + 18][in_index];   
   }
   else
   {
     for( j = 0; j < 18; j++ )
    if( (in_value >= dat[ind_I*19 + j][in_index] && in_value < dat[ind_I*19 + j + 1][in_index])||
      (in_value <= dat[ind_I*19 + j][in_index] && in_value > dat[ind_I*19 + j + 1][in_index]) )
           {ind_J=j; break;}
   }
   
   if( in_value < dat[(ind_I + 1)*19][in_index] )
    {
       ind_K = 0;
       in_value = dat[(ind_I+1)*19][in_index];   
    }
   else if( in_value > dat[(ind_I + 1)*19 + 18][in_index] )
    {
      ind_K = 18;
      in_value = dat[(ind_I + 1)*19 + 18][in_index];   
    }
   else
    {
       for( k = 0; k < 18; k++ )
       if( (in_value >= dat[(ind_I + 1)*19 + k][in_index] 
          && in_value < dat[(ind_I + 1)*19 +k +1][in_index] ) ||
         (in_value <= dat[(ind_I + 1)*19 + k][in_index] 
          && in_value > dat[(ind_I + 1)*19 +k +1][in_index] ) )
         {ind_K=k; break;}
    }
    
   

   a = ww - dat[ind_I*19][0];          
   b = dat[(ind_I+1) *19][0] - ww;

   ta = (dat[(ind_I+1) *19 + ind_K][in_index] * a
         + dat[ind_I*19 + ind_J][in_index] * b) / (a + b);

   outa = (dat[(ind_I+1) *19  + ind_K][out_index] * a
         + dat[ind_I*19 + ind_J][out_index] * b) / (a + b);

   tb = (dat[(ind_I+1) *19  + ind_K + 1][in_index] * a
         + dat[ind_I*19 + ind_J + 1][in_index] * b) / (a + b);

   outb = (dat[(ind_I+1) *19 + ind_K + 1][out_index] * a
         + dat[ind_I*19 + ind_J + 1][out_index] * b) / (a + b);
   a =((in_value) - (ta));
   b = ((tb) - (in_value)); 
   r = (outb*a + outa*b) / (a + b); 
   
   Index[0]=ind_I;
   Index[1]=ind_J;
   Index[2]=ind_K;
   return( r );
}

