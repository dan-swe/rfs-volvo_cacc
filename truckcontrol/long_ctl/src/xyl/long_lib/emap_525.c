/************************************************************************

      eng_map()

      input: we - [rpm]
      eng_tbl: ww - rad/s]
      This conversion is important.
      For each spd 19 points
      19 spd
      dat[361][4]
                             
*************************************************************************/

#include <math.h>
#include <stdio.h>

float eng_map( float we, float in_value, int in_index, int out_index , int Index[3])
{
        float  outa, outb, a, b, r, ww;
        float ta=0.0,tb=0.0;                        
        int i, j, k;
        int ind_I=0, ind_J=0, ind_K=0;
        const float dat[304][4]={600.000,   0.000,  101300.000,  10.000,
600.000,  248.228,  111233.575,  15.000,
600.000,  415.317,  116446.445,  20.000,
600.000,  582.406,  121882.387,  25.000,
600.000,  749.494,  127554.001,  30.000,
600.000,  916.583,  133368.219,  35.000,
600.000,  1083.672,  139353.453,  40.000,
600.000,  1092.538,  145470.329,  45.000,
600.000,  1092.538,  148984.570,  50.000,
600.000,  1092.538,  149040.084,  55.000,
600.000,  1102.538,  149040.461,  60.000,
600.000,  1102.538,  149040.464,  65.000,
600.000,  1132.538,  149040.464,  70.000,
600.000,  1132.538,  149040.464,  75.000,
600.000,  1132.538,  149040.464,  80.000,
600.000,  1142.538,  149040.464,  85.000,
600.000,  1142.538,  149040.464,  90.000,
600.000,  1152.538,  149040.464,  95.000,
600.000,  1152.538,  149040.464,  100.000,            
700.000,   0.000,  101300.000,  10.000,
700.000,  268.228,  111233.575,  15.000,
700.000,  435.317,  116446.445,  20.000,
700.000,  602.406,  121882.387,  25.000,
700.000,  769.494,  127554.001,  30.000,
700.000,  936.583,  133368.219,  35.000,
700.000,  1103.672,  139353.453,  40.000,
700.000,  1112.538,  145470.329,  45.000,
700.000,  1122.538,  148984.570,  50.000,
700.000,  1132.538,  149040.084,  55.000,
700.000,  1142.538,  149040.461,  60.000,
700.000,  1152.538,  149040.464,  65.000,
700.000,  1152.538,  149040.464,  70.000,
700.000,  1162.538,  149040.464,  75.000,
700.000,  1162.538,  149040.464,  80.000,
700.000,  1162.538,  149040.464,  85.000,
700.000,  1172.538,  149040.464,  90.000,
700.000,  1172.538,  149040.464,  95.000,
700.000,  1172.538,  149040.464,  100.000,
800.000,  53.911,  107659.193,  10.000,
800.000,  229.861,  113354.140,  15.000,
800.000,  408.645,  119391.808,  20.000,
800.000,  591.896,  125687.500,  25.000,
800.000,  792.357,  132218.727,  30.000,
800.000,  984.613,  138998.353,  35.000,
800.000,  1161.662,  145916.464,  40.000,
800.000,  1183.627,  152849.791,  45.000,
800.000,  1208.720,  156781.119,  50.000,
800.000,  1228.720,  156781.119,  55.000,
800.000,  1258.720,  156781.119,  60.000,
800.000,  1288.720,  156781.119,  65.000,
800.000,  1318.720,  156781.119,  70.000,
800.000,  1338.720,  156781.119,  75.000,
800.000,  1358.720,  156781.119,  80.000,
800.000,  1378.720,  156781.119,  85.000,
800.000,  1388.720,  156781.048,  90.000,
800.000,  1398.720,  156770.665,  95.000,
800.000,  1398.154,  155243.513,  100.000,
900.000,   8.293,  105745.698,  10.000,
900.000,  203.261,  110372.305,  15.000,
900.000,  398.808,  116901.689,  20.000,
900.000,  596.817,  123818.211,  25.000,
900.000,  810.512,  131056.998,  30.000,
900.000,  968.891,  138585.148,  35.000,
900.000,  1126.791,  146297.449,  40.000,
900.000,  1285.041,  154062.132,  45.000,
900.000,  1434.588,  161940.285,  50.000,
900.000,  1586.545,  170056.354,  55.000,
900.000,  1591.577,  177702.034,  60.000,
900.000,  1601.577,  178273.905,  65.000,
900.000,  1611.577,  178277.793,  70.000,
900.000,  1621.577,  178277.819,  75.000,
900.000,  1631.577,  178277.820,  80.000,
900.000,  1641.577,  178277.820,  85.000,
900.000,  1651.577,  178277.820,  90.000,
900.000,  1661.577,  178277.820,  95.000,
900.000,  1671.577,  178277.820,  100.000,
1000.000,  -67.417,  105419.738,  10.000,
1000.000,  119.115,  112015.715,  15.000,
1000.000,  300.641,  119360.386,  20.000,
1000.000,  479.869,  126341.120,  25.000,
1000.000,  660.104,  135271.484,  30.000,
1000.000,  829.970,  143680.642,  35.000,
1000.000,  1014.428,  152232.063,  40.000,
1000.000,  1188.928,  160854.112,  45.000,
1000.000,  1361.414,  169772.229,  50.000,
1000.000,  1531.719,  178955.062,  55.000,
1000.000,  1705.155,  188139.461,  60.000,
1000.000,  1877.016,  197333.138,  65.000,
1000.000,  2006.102,  205540.532,  70.000,
1000.000,  2019.710,  208983.903,  75.000,
1000.000,  2029.686,  208980.163,  80.000,
1000.000,  2039.515,  208953.583,  85.000,
1000.000,  2048.298,  208764.686,  90.000,
1000.000,  2039.649,  207422.231,  95.000,
1000.000,  1966.978,  197285.585,  100.000,
1100.000,  -141.838,  102861.872,  10.000,
1100.000,  34.433,  107657.979,  15.000,
1100.000,  213.689,  115299.017,  20.000,
1100.000,  406.647,  123561.127,  25.000,
1100.000,  622.924,  132279.773,  30.000,
1100.000,  829.718,  141371.342,  35.000,
1100.000,  1005.644,  150680.974,  40.000,
1100.000,  1157.445,  160058.442,  45.000,
1100.000,  1296.368,  169772.859,  50.000,
1100.000,  1448.386,  179772.165,  55.000,
1100.000,  1592.620,  189783.937,  60.000,
1100.000,  1780.819,  199873.969,  65.000,
1100.000,  1956.992,  210305.627,  70.000,
1100.000,  2105.461,  220909.646,  75.000,
1100.000,  2249.150,  231370.046,  80.000,
1100.000,  2330.621,  243133.940,  85.000,
1100.000,  2335.138,  245029.429,  90.000,
1100.000,  2335.138,  245050.354,  95.000,
1100.000,  2335.138,  245050.496,  100.000,
1200.000,  -185.979,  101988.185,  10.000,
1200.000,  -11.269,  108804.294,  15.000,
1200.000,  189.339,  117262.072,  20.000,
1200.000,  389.354,  125411.161,  25.000,
1200.000,  585.413,  135935.061,  30.000,
1200.000,  764.673,  145884.810,  35.000,
1200.000,  943.934,  155966.378,  40.000,
1200.000,  1123.194,  166310.927,  45.000,
1200.000,  1299.523,  177048.976,  50.000,
1200.000,  1461.221,  187870.546,  55.000,
1200.000,  1611.339,  198733.471,  60.000,
1200.000,  1761.457,  209981.801,  65.000,
1200.000,  1910.799,  221450.862,  70.000,
1200.000,  2058.501,  232778.400,  75.000,
1200.000,  2206.476,  244348.744,  80.000,
1200.000,  2355.630,  256108.571,  85.000,
1200.000,  2503.566,  266850.795,  90.000,
1200.000,  2522.788,  267273.756,  95.000,
1200.000,  2519.452,  262784.831,  100.000,
1300.000,  -197.906,  101294.747,  10.000,
1300.000,  -83.475,  103807.081,  15.000,
1300.000,  135.417,  111818.893,  20.000,
1300.000,  350.845,  121151.197,  25.000,
1300.000,  543.122,  131155.276,  30.000,
1300.000,  706.051,  141688.319,  35.000,
1300.000,  878.696,  152490.807,  40.000,
1300.000,  1045.989,  163474.354,  45.000,
1300.000,  1206.336,  174914.656,  50.000,
1300.000,  1366.713,  186529.127,  55.000,
1300.000,  1527.219,  198182.704,  60.000,
1300.000,  1687.805,  210259.725,  65.000,
1300.000,  1848.110,  222524.070,  70.000,
1300.000,  2007.913,  234746.328,  75.000,
1300.000,  2168.286,  247161.271,  80.000,
1300.000,  2329.013,  261181.755,  85.000,
1300.000,  2459.363,  272726.651,  90.000,
1300.000,  2501.763,  282076.361,  95.000,
1300.000,  2501.763,  282348.031,  100.000,
1400.000,  -209.977,  101318.093,  10.000,
1400.000,  -168.655,  104384.917,  15.000,
1400.000,  32.281,  113232.288,  20.000,
1400.000,  222.480,  123337.022,  25.000,
1400.000,  412.343,  134172.559,  30.000,
1400.000,  596.221,  145535.790,  35.000,
1400.000,  767.265,  157085.285,  40.000,
1400.000,  938.274,  169007.170,  45.000,
1400.000,  1109.278,  181377.838,  50.000,
1400.000,  1276.338,  193773.321,  55.000,
1400.000,  1437.809,  206461.411,  60.000,
1400.000,  1608.851,  219589.146,  65.000,
1400.000,  1779.866,  232542.410,  70.000,
1400.000,  1950.960,  245793.445,  75.000,
1400.000,  2119.379,  259333.373,  80.000,
1400.000,  2256.156,  273004.130,  85.000,
1400.000,  2372.015,  286661.638,  90.000,
1400.000,  2467.530,  298370.540,  95.000,
1400.000,  2469.596,  295365.911,  100.000,
1500.000,  -222.002,  101290.191,  10.000,
1500.000,  -222.075,  101290.001,  15.000,
1500.000,  -49.847,  106726.247,  20.000,
1500.000,  154.779,  116736.263,  25.000,
1500.000,  358.996,  127797.280,  30.000,
1500.000,  560.229,  139562.356,  35.000,
1500.000,  741.508,  151772.763,  40.000,
1500.000,  911.589,  164215.205,  45.000,
1500.000,  1084.069,  177219.494,  50.000,
1500.000,  1220.204,  190372.985,  55.000,
1500.000,  1352.177,  203728.895,  60.000,
1500.000,  1529.526,  217628.456,  65.000,
1500.000,  1700.900,  231381.320,  70.000,
1500.000,  1878.795,  245430.978,  75.000,
1500.000,  2016.275,  259812.469,  80.000,
1500.000,  2136.778,  274326.962,  85.000,
1500.000,  2289.773,  288842.446,  90.000,
1500.000,  2439.890,  303383.175,  95.000,
1500.000,  2439.890,  312477.250,  100.000,
1600.000,  -234.974,  101290.985,  10.000,
1600.000,  -234.974,  101434.915,  15.000,
1600.000,  -125.007,  107557.016,  20.000,
1600.000,  94.057,  118312.399,  25.000,
1600.000,  309.991,  130137.748,  30.000,
1600.000,  514.192,  142705.321,  35.000,
1600.000,  666.494,  155649.732,  40.000,
1600.000,  811.169,  168978.170,  45.000,
1600.000,  993.639,  182848.637,  50.000,
1600.000,  1147.878,  196766.475,  55.000,
1600.000,  1335.949,  211178.233,  60.000,
1600.000,  1486.445,  225801.452,  65.000,
1600.000,  1618.181,  240546.892,  70.000,
1600.000,  1797.336,  255583.087,  75.000,
1600.000,  1947.707,  270913.485,  80.000,
1600.000,  2075.914,  286243.988,  85.000,
1600.000,  2208.900,  301589.989,  90.000,
1600.000,  2323.826,  317102.857,  95.000,
1600.000,  2340.381,  320933.588,  100.000,
1700.000,  -247.894,  101290.007,  10.000,
1700.000,  -247.972,  101290.000,  15.000,
1700.000,  -221.192,  101666.556,  20.000,
1700.000,  -25.178,  110574.471,  25.000,
1700.000,  170.836,  122276.914,  30.000,
1700.000,  366.850,  135058.114,  35.000,
1700.000,  563.924,  148508.576,  40.000,
1700.000,  760.324,  162246.946,  45.000,
1700.000,  915.804,  176635.916,  50.000,
1700.000,  1052.325,  191249.654,  55.000,
1700.000,  1234.959,  206153.168,  60.000,
1700.000,  1408.127,  221589.617,  65.000,
1700.000,  1544.246,  236994.928,  70.000,
1700.000,  1678.754,  252727.581,  75.000,
1700.000,  1813.235,  268841.398,  80.000,
1700.000,  1947.733,  284969.290,  85.000,
1700.000,  2082.261,  301098.679,  90.000,
1700.000,  2182.107,  317645.528,  95.000,
1700.000,  2182.107,  324536.933,  100.000,
1800.000,  -262.121,  101290.030,  10.000,
1800.000,  -262.121,  101294.349,  15.000,
1800.000,  -262.121,  101929.725,  20.000,
1800.000,  -115.241,  111457.769,  25.000,
1800.000,  72.509,  123887.718,  30.000,
1800.000,  259.705,  137425.840,  35.000,
1800.000,  446.301,  151607.978,  40.000,
1800.000,  621.645,  166154.962,  45.000,
1800.000,  782.138,  181386.772,  50.000,
1800.000,  942.618,  196743.921,  55.000,
1800.000,  1112.800,  212681.492,  60.000,
1800.000,  1289.426,  228772.055,  65.000,
1800.000,  1428.922,  245131.323,  70.000,
1800.000,  1563.319,  261891.116,  75.000,
1800.000,  1705.631,  278805.764,  80.000,
1800.000,  1852.281,  295723.506,  85.000,
1800.000,  1998.931,  312843.328,  90.000,
1800.000,  2057.613,  323195.841,  95.000,
1800.000,  2058.522,  323584.161,  100.000,
1900.000,  -276.879,  101290.000,  10.000,
1900.000,  -276.969,  101290.000,  15.000,
1900.000,  -276.969,  101290.000,  20.000,
1900.000,  -203.920,  103628.028,  25.000,
1900.000,  -23.608,  114842.823,  30.000,
1900.000,  134.377,  128237.623,  35.000,
1900.000,  296.281,  142679.631,  40.000,
1900.000,  459.042,  157598.094,  45.000,
1900.000,  615.890,  173182.573,  50.000,
1900.000,  767.910,  189196.640,  55.000,
1900.000,  921.382,  205483.226,  60.000,
1900.000,  1079.452,  222378.626,  65.000,
1900.000,  1237.553,  239313.170,  70.000,
1900.000,  1395.653,  256665.777,  75.000,
1900.000,  1553.754,  274341.299,  80.000,
1900.000,  1711.854,  292022.332,  85.000,
1900.000,  1869.955,  309895.715,  90.000,
1900.000,  1896.677,  321470.973,  95.000,
1900.000,  1896.677,  321701.560,  100.000,
2000.000,  -291.968,  101290.001,  10.000,
2000.000,  -291.968,  101290.112,  15.000,
2000.000,  -291.968,  101306.455,  20.000,
2000.000,  -285.675,  103691.080,  25.000,
2000.000,  -83.720,  115758.712,  30.000,
2000.000,  117.231,  129846.303,  35.000,
2000.000,  313.327,  144999.992,  40.000,
2000.000,  498.174,  160624.052,  45.000,
2000.000,  651.669,  177032.940,  50.000,
2000.000,  800.274,  193745.377,  55.000,
2000.000,  949.057,  210960.416,  60.000,
2000.000,  1103.441,  228521.705,  65.000,
2000.000,  1235.732,  246344.105,  70.000,
2000.000,  1359.319,  264647.968,  75.000,
2000.000,  1482.535,  283074.912,  80.000,
2000.000,  1610.678,  301520.078,  85.000,
2000.000,  1757.378,  319792.694,  90.000,
2000.000,  1757.378,  323410.688,  95.000,
2000.000,  1758.184,  322344.273,  100.000,
2100.000,  -307.022,  101290.000,  10.000,
2100.000,  -307.116,  101290.000,  15.000,
2100.000,  -307.116,  101290.000,  20.000,
2100.000,  -307.116,  101290.000,  25.000,
2100.000,  -180.264,  106199.598,  30.000,
2100.000,   2.240,  119430.469,  35.000,
2100.000,  164.268,  134428.226,  40.000,
2100.000,  310.492,  150402.914,  45.000,
2100.000,  468.079,  166865.275,  50.000,
2100.000,  625.672,  184148.787,  55.000,
2100.000,  774.349,  201647.249,  60.000,
2100.000,  913.281,  219897.684,  65.000,
2100.000,  1012.169,  238191.635,  70.000,
2100.000,  1105.872,  256977.927,  75.000,
2100.000,  1199.575,  276122.968,  80.000,
2100.000,  1293.278,  295274.431,  85.000,
2100.000,  1377.101,  314760.904,  90.000,
2100.000,  1377.101,  322285.476,  95.000,
2100.000,  1377.101,  322352.519,  100.000
};

        ww = we;     // * 2.0 * PI / 60.0;      /* rpm to rad/s */

        if( ww <= dat[0][0] )
        {
                ind_I = 0;
                ww = dat[0][0];
        }
        else if( ww >= dat[303][0] )
        {
                ind_I = 14;              // Err
                ww = dat[303][0];
        }
        else
        {
                for( i = 0; i < 15; i++ )
                        if( (ww >= dat[i*19][0] && ww < dat[(i+1) * 19][0] ) ||
                            (ww <= dat[i*19][0] && ww > dat[(i+1) * 19][0] ) ) 
                               {ind_I=i; break;}
        }                                                                              


        if( in_value < dat[ind_I*19][in_index] )
        {
              ind_J = 0;
              in_value = dat[ind_I*19][in_index];   
        }
        else if( in_value > dat[ind_I*19 + 18][in_index] )
        {
              ind_J = 18;
                 in_value = dat[ind_I*19 + 18][in_index];   
        }
        else
        {
            for( j = 0; j < 18; j++ )
              if( (in_value >= dat[ind_I*19 + j][in_index] && in_value < dat[ind_I*19 + j + 1][in_index])||
                  (in_value <= dat[ind_I*19 + j][in_index] && in_value > dat[ind_I*19 + j + 1][in_index]) )
                               {ind_J=j; break;}
        }
        
        if( in_value < dat[(ind_I + 1)*19][in_index] )
           {
                   ind_K = 0;
                   in_value = dat[(ind_I+1)*19][in_index];   
           }
        else if( in_value > dat[(ind_I + 1)*19 + 18][in_index] )
           {
                  ind_K = 18;
                  in_value = dat[(ind_I + 1)*19 + 18][in_index];   
           }
        else
           {
                   for( k = 0; k < 18; k++ )
                      if( (in_value >= dat[(ind_I + 1)*19 + k][in_index] 
                           && in_value < dat[(ind_I + 1)*19 +k +1][in_index] ) ||
                        (in_value <= dat[(ind_I + 1)*19 + k][in_index] 
                           && in_value > dat[(ind_I + 1)*19 +k +1][in_index] ) )
                             {ind_K=k; break;}
           }
           
        

        a = ww - dat[ind_I*19][0];                                   
        b = dat[(ind_I+1) *19][0] - ww;

        ta = (dat[(ind_I+1) *19 + ind_K][in_index] * a
                        + dat[ind_I*19 + ind_J][in_index] * b) / (a + b);

        outa = (dat[(ind_I+1) *19  + ind_K][out_index] * a
                        + dat[ind_I*19 + ind_J][out_index] * b) / (a + b);

        tb = (dat[(ind_I+1) *19  + ind_K + 1][in_index] * a
                        + dat[ind_I*19 + ind_J + 1][in_index] * b) / (a + b);

        outb = (dat[(ind_I+1) *19 + ind_K + 1][out_index] * a
                        + dat[ind_I*19 + ind_J + 1][out_index] * b) / (a + b);
        a =((in_value) - (ta));
        b = ((tb) - (in_value)); 
        r = (outb*a + outa*b) / (a + b); 
        
        Index[0]=ind_I;
        Index[1]=ind_J;
        Index[2]=ind_K;
        return( r );
}

